name: Daily Health Check

on:
  schedule:
    # Run every day at 8:00 AM US/Chicago (14:00 UTC)
    - cron: "0 14 * * *"
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: read
  issues: write # Needed to create issues on failure

jobs:
  health-check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          ref: develop

      # --- Backend Setup & Test ---
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install Backend Dependencies
        run: |
          cd backend
          python -m venv venv
          source venv/bin/activate
          pip install -r ../requirements.txt
          pip install pytest pytest-cov httpx

      - name: Run Backend Tests & Coverage
        id: backend
        run: |
          cd backend
          source venv/bin/activate
          # Run tests and output coverage report to terminal. Fail under 50%.
          set -o pipefail
          pytest --cov=. --cov-report=term-missing --cov-fail-under=50 tests/ 2>&1 | tee ../backend_test.log
        continue-on-error: true

      # --- Frontend Setup & Test ---
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install Frontend Dependencies
        run: |
          cd frontend
          npm ci

      - name: Run Frontend Tests & Coverage
        id: frontend
        run: |
          cd frontend
          # Fail if coverage is under 50%
          set -o pipefail
          npm run test:run -- --coverage --coverage.thresholds.lines=50 2>&1 | tee ../frontend_test.log
        continue-on-error: true

      # --- Reporting ---
      - name: Create Issue on Failure
        if: always() && (steps.backend.outcome == 'failure' || steps.frontend.outcome == 'failure')
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const date = new Date().toLocaleDateString();

            let backendLog = '';
            let frontendLog = '';

            try { backendLog = fs.readFileSync('backend_test.log', 'utf8'); } catch (e) { backendLog = 'Log file not found.'; }
            try { frontendLog = fs.readFileSync('frontend_test.log', 'utf8'); } catch (e) { frontendLog = 'Log file not found.'; }

            // Helper to extract relevant failure lines
            function getFailureSummary(log) {
              if (!log) return 'No log available (Step might have been skipped).';
              const lines = log.split('\n');
              // Simple heuristic: grab lines with "FAILED" or "ERROR" or the summary at the end
              const failures = lines.filter(l => l.includes('FAILED') || l.includes('Error:') || l.includes('FAIL'));
              const summary = lines.slice(-20).join('\n'); // Last 20 lines usually have the summary
              
              if (failures.length > 0) {
                 return `### âŒ Detected Failures:\n\`\`\`\n${failures.slice(0, 10).join('\n')}\n...\n\`\`\`\n\n### ğŸ“‹ Log Summary:\n\`\`\`\n${summary}\n\`\`\``;
              }
              return `### ğŸ“‹ Log Summary:\n\`\`\`\n${summary}\n\`\`\``;
            }

            const backendSummary = getFailureSummary(backendLog);
            const frontendSummary = getFailureSummary(frontendLog);

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸš¨ Health / Coverage Alert: ${date}`,
              body: `The Daily Health Check workflow failed on ${date}. 
              
              ## ğŸ Backend Status: ${context.steps.backend.outcome.toUpperCase()}
              ${backendSummary}
              
              ## âš›ï¸ Frontend Status: ${context.steps.frontend.outcome.toUpperCase()}
              ${frontendSummary}
              
              ---
              [View Full Actions Log](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`,
              labels: ['bug', 'automated-report', 'coverage']
            });

            // Fail the workflow if any step failed
            core.setFailed("One or more health checks failed. See issue for details.");
